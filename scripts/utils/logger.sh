#!/bin/bash

################################################################################
# 日志模块
# 用途: 提供统一的日志输出功能，支持不同级别的日志记录
# 使用: source scripts/utils/logger.sh
################################################################################

# 加载颜色模块
# 如果 colors.sh 还未加载，则加载它
if [ -z "$COLOR_RESET" ]; then
    LOGGER_SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    source "${LOGGER_SCRIPT_DIR}/colors.sh"
fi

# 日志文件配置
LOG_DIR="${LOG_DIR:-/tmp/install_everything}"
LOG_FILE="${LOG_DIR}/install_$(date +%Y%m%d_%H%M%S).log"

# 创建日志目录
mkdir -p "${LOG_DIR}"

# 日志级别
LOG_LEVEL_DEBUG=0
LOG_LEVEL_INFO=1
LOG_LEVEL_WARN=2
LOG_LEVEL_ERROR=3
LOG_LEVEL_SUCCESS=4

# 当前日志级别 (默认: INFO)
CURRENT_LOG_LEVEL=${CURRENT_LOG_LEVEL:-$LOG_LEVEL_INFO}

################################################################################
# 获取时间戳
################################################################################
get_timestamp() {
    date '+%Y-%m-%d %H:%M:%S'
}

################################################################################
# 写入日志文件
# 参数:
#   $1 - 日志级别
#   $2 - 日志消息
################################################################################
write_log_file() {
    local level="$1"
    local message="$2"
    echo "[$(get_timestamp)] [$level] $message" >> "${LOG_FILE}"
}

################################################################################
# DEBUG 级别日志
# 用途: 输出调试信息
# 参数: $1 - 日志消息
################################################################################
log_debug() {
    if [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_DEBUG ]; then
        print_cyan "[DEBUG] $1"
        write_log_file "DEBUG" "$1"
    fi
}

################################################################################
# INFO 级别日志
# 用途: 输出一般信息
# 参数: $1 - 日志消息
################################################################################
log_info() {
    if [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_INFO ]; then
        print_blue "[INFO] $1"
        write_log_file "INFO" "$1"
    fi
}

################################################################################
# WARN 级别日志
# 用途: 输出警告信息
# 参数: $1 - 日志消息
################################################################################
log_warn() {
    if [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_WARN ]; then
        print_yellow "[WARN] $1"
        write_log_file "WARN" "$1"
    fi
}

################################################################################
# ERROR 级别日志
# 用途: 输出错误信息
# 参数: $1 - 日志消息
################################################################################
log_error() {
    if [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_ERROR ]; then
        print_bold_red "[ERROR] $1"
        write_log_file "ERROR" "$1"
    fi
}

################################################################################
# SUCCESS 级别日志
# 用途: 输出成功信息
# 参数: $1 - 日志消息
################################################################################
log_success() {
    print_bold_green "[SUCCESS] $1"
    write_log_file "SUCCESS" "$1"
}

################################################################################
# 步骤日志
# 用途: 输出安装步骤信息
# 参数: $1 - 步骤消息
################################################################################
log_step() {
    print_bold_blue "===> $1"
    write_log_file "STEP" "$1"
}

################################################################################
# 分隔线
# 用途: 输出分隔线，用于区分不同的安装阶段
################################################################################
log_separator() {
    local separator="================================================================================"
    echo -e "${COLOR_CYAN}${separator}${COLOR_RESET}"
    echo "$separator" >> "${LOG_FILE}"
"q}

################################################################################
# 获取日志文件路径
################################################################################
get_log_file() {
    echo "${LOG_FILE}"
}

################################################################################
# 初始化日志系统
################################################################################
init_logger() {
    log_info "日志系统初始化完成"
    log_info "日志文件: ${LOG_FILE}"
}

